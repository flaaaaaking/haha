<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MBTI 决策工具 v1.1.3</title>
<meta name="apple-mobile-web-app-title" content="MBTI 决策工具 v1.1.3">
<meta property="og:title" content="MBTI 决策工具 v1.1.3">
<style>
:root{
  --bg:#0f1115; --panel:#151922; --text:#e8ecf2; --muted:#9aa3b2; --line:#242a34;
  --chip:#1b2029; --chipbd:#2a3140; --input:#0e131a; --inputbd:#334155; --code:#0a0f16;
  --brand:#7E57C2; --brand-acc:#9575CD; --brand-hi:#B39DDB; --btn-bg:var(--brand);
}
body.theme-light{
  --bg:#f7f9fb; --panel:#ffffff; --text:#111827; --muted:#6b7280; --line:#d1d5db;
  --chip:#f3f4f6; --chipbd:#e5e7eb; --input:#f3f4f6; --inputbd:#e5e7eb; --code:#f5f7fa;
}
body.theme-dark{
  --bg:#0f1115; --panel:#151922; --text:#e8ecf2; --muted:#9aa3b2; --line:#242a34;
  --chip:#1b2029; --chipbd:#2a3140; --input:#0e131a; --inputbd:#334155; --code:#0a0f16;
}

/* 基础排版 */
*{box-sizing:border-box}
body{
  margin:0; background:var(--bg); color:var(--text);
  font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,
       "PingFang SC","Noto Sans CJK SC","Microsoft YaHei",sans-serif;
}
.wrap{max-width:1200px;margin:0 auto;padding:20px}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px}
h1{font-size:22px;margin:0 0 6px}
.muted{color:var(--muted)}

/* 栅格与卡片 */
.grid{display:grid;grid-template-columns:1fr;gap:16px}
@media(min-width:1024px){.grid{grid-template-columns:1fr 1.4fr 1fr}}
.card{
  background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0));
  border:1px solid var(--line); border-radius:16px; padding:14px;
}

/* 表单与按钮 */
select,textarea,input[type="text"]{
  width:100%; background:var(--input); color:var(--text);
  border:1px solid var(--inputbd); border-radius:10px; padding:8px;
}
.btns{display:flex;gap:8px;flex-wrap:wrap}
.btn{
  background:transparent; border:1px solid var(--line); color:var(--text);
  border-radius:10px; padding:6px 10px; cursor:pointer; transition:.15s ease;
}
.btn:hover{filter:brightness(.98)}
.btn.primary{background:var(--btn-bg); border-color:var(--btn-bg); color:#fff}

/* 筛选 Chip */
.chips{display:flex;flex-wrap:wrap;gap:8px}
.chip{
  background:var(--chip); border:1px solid var(--chipbd);
  border-radius:999px; padding:6px 10px; cursor:pointer;
}
.chip.on{background:var(--brand-hi); color:#0f172a; border-color:var(--brand-hi)}

/* 列表与条形图 */
.list{display:grid;gap:10px}
.item{border:1px solid var(--line); border-radius:12px; padding:10px}
.kv{display:flex;justify-content:space-between;align-items:center}
.sub{color:var(--muted); font-size:12px}

.bar{
  position:relative; height:8px; background:var(--chip);
  border:1px solid var(--chipbd); border-radius:999px; overflow:hidden; margin-top:6px;
}
.bar i{display:block; height:100%; background:var(--brand-acc)}

/* 代码块与页脚 */
pre{
  white-space:pre-wrap; background:var(--code); border:1px solid var(--line);
  border-radius:12px; padding:10px; max-height:320px; overflow:auto;
}
footer{color:var(--muted); text-align:center; font-size:12px; padding:24px 0}
code{background:var(--code); border:1px solid var(--line); padding:2px 6px; border-radius:6px}
</style>
</head>
<body class="theme-light">
<div class="wrap">
  <div class="header">
    <div>
      <h1>MBTI 决策工具 v1.1.3</h1>
      <p class="muted">纯本地运行，免 API。数据仅存在 <code>localStorage</code>（Notion 环境将自动降级兼容）。</p>
    </div>
    <div class="btns">
      <button class="btn" id="themeToggle">切换主题：白天</button>
    </div>
  </div>

  <div class="grid">
    <!-- 左：输入 -->
    <section class="card">
      <h2>参数</h2>
      <div class="card" style="margin:10px 0">
        <h3>快速开始</h3>
        <div class="btns">
          <button class="btn primary" id="demoBtn">示例填充</button>
          <button class="btn" id="saveProfile">保存配置</button>
          <button class="btn" id="loadProfile">读取</button>
          <button class="btn" id="exportJSON">导出 JSON</button>
        </div>
      </div>

      <label>类型（16 型）</label>
      <select id="type"></select>

      <label style="margin-top:8px;display:block">项目阶段</label>
      <select id="phase"></select>

      <label style="margin-top:8px;display:block">目标（多选）</label>
      <div id="goals" class="chips"></div>

      <label style="margin-top:8px;display:block">任务/问题（自然语言）</label>
      <textarea id="task" rows="6" placeholder="每行一条；也支持中文标点/项目符号分隔。例：&#10;给父母体检预约（周六）&#10;厨房水槽渗水（影响做饭）&#10;下周一周会汇报（PPT）"></textarea>

      <h3 style="margin-top:10px">手动微调（功能加成）</h3>
      <div id="manual"></div>
      <div class="btns"><button class="btn" id="resetManual">重置</button></div>
    </section>

    <!-- 中：权重与解释 -->
    <section class="card">
      <div class="card" style="margin-bottom:12px">
        <h3>术语小抄</h3>
        <p class="sub">Ni 远期图景｜Ne 可能路径｜Si 经验基线｜Se 现实输入｜Fi 个人价值｜Fe 群体关系｜Ti 逻辑正确｜Te 执行效率</p>
      </div>
      <div class="kv">
        <h2>功能权重</h2>
        <button class="btn" id="explainToggle">解释：开启</button>
      </div>
      <div id="weights" class="list"></div>
      <div class="card" style="margin-top:12px">
        <h3>阶段/目标影响</h3>
        <p class="muted" id="phaseGoalDesc"></p>
        <p class="sub">说明：系统融合“类型堆栈、项目阶段、目标偏好、手动微调”，并做归一化。</p>
      </div>
    </section>

    <!-- 右：结果与导出 -->
    <section class="card">
      <h2>建议优先级（Top 6）</h2>
      <div class="card" style="margin:12px 0">
        <h3>一行话结论</h3>
        <p class="muted" id="oneLine"></p>
        <h3>下一步动作（最多 3 条）</h3>
        <div id="nextActions" class="list"></div>
      </div>

      <div id="cats" class="list"></div>

      <div class="card" style="margin-top:12px">
        <h3>任务优先队列（高→低）</h3>
        <div id="taskQueue" class="list"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>导出</h3>
        <div class="btns"><button class="btn primary" id="copyMd">复制 Markdown</button></div>
        <pre id="md"></pre>
      </div>
    </section>
  </div>

  <footer>离线 · 免 API · 决策仅作偏好参考，不作为唯一依据。</footer>
</div>

<script>
/* ====== Notion/iframe 兼容层：存储/复制/下载/报错 ====== */
const ENV = {
  inIframe:(()=>{try{return window.top!==window}catch{return true}})(),
  inNotion:(()=> (document.referrer||'').includes('notion.so'))()
};
ENV.isNotionEmbed = ENV.inIframe || ENV.inNotion;

const MemoryStore=(()=>{const bag=Object.create(null);return{
  getItem:k=>bag[k]??null,setItem:(k,v)=>bag[k]=String(v),removeItem:k=>delete bag[k]
}})();
const SafeStore=(()=>{try{const k='__probe__'+Date.now();localStorage.setItem(k,'1');localStorage.removeItem(k);return localStorage}catch{return MemoryStore}})();

function toast(msg,ms=1800){
  let t=document.getElementById('__toast__');
  if(!t){t=document.createElement('div');t.id='__toast__';t.style.cssText=
    'position:fixed;left:50%;top:18px;transform:translateX(-50%);background:rgba(0,0,0,.75);color:#fff;padding:8px 12px;border-radius:10px;font:13px/1.3 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;z-index:2147483647;opacity:0;transition:opacity .15s;pointer-events:none;max-width:80vw;text-align:center';
    document.body.appendChild(t)}
  t.textContent=String(msg||'');t.style.opacity='1';clearTimeout(t.__timer);t.__timer=setTimeout(()=>t.style.opacity='0',ms);
}
async function safeCopy(text){
  try{await navigator.clipboard.writeText(text);toast('已复制到剪贴板')}
  catch{try{const ta=document.createElement('textarea');ta.value=text;ta.setAttribute('readonly','readonly');ta.style.cssText='position:fixed;left:-9999px;top:-9999px';document.body.appendChild(ta);ta.select();document.execCommand('copy');ta.remove();toast('已复制（兼容模式）')}catch{toast('复制失败：请手动全选复制')}}}
function safeDownload(filename,content,mime='application/octet-stream'){
  try{const blob=new Blob([content],{type:mime});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=filename;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);toast('已触发下载')}
  catch{const pre=document.querySelector('#md');if(pre){pre.textContent=String(content);toast('下载受限，已在下方显示内容')}}}
window.addEventListener('error',e=>{if(ENV.isNotionEmbed)toast('脚本错误：'+(e?.message||'未知'))});

/* ====== 主题 ====== */
function setTheme(mode){
  document.body.classList.remove('theme-light','theme-dark');
  document.body.classList.add(mode==='dark'?'theme-dark':'theme-light');
  SafeStore.setItem('mbti_theme', mode);
  const btn=document.getElementById('themeToggle');
  if(btn) btn.textContent='切换主题：'+(mode==='dark'?'夜晚':'白天');
}
(function(){setTheme(SafeStore.getItem('mbti_theme')||'light')})();
document.getElementById('themeToggle').onclick=()=>setTheme(
  document.body.classList.contains('theme-light')?'dark':'light'
);

/* ====== 数据 ====== */
const MBTI_STACKS={
  INTJ:["Ni","Te","Fi","Se"], INTP:["Ti","Ne","Si","Fe"], INFJ:["Ni","Fe","Ti","Se"], INFP:["Fi","Ne","Si","Te"],
  ISTJ:["Si","Te","Fi","Ne"], ISTP:["Ti","Se","Ni","Fe"], ISFJ:["Si","Fe","Ti","Ne"], ISFP:["Fi","Se","Ni","Te"],
  ENTJ:["Te","Ni","Se","Fi"], ENTP:["Ne","Ti","Fe","Si"], ENFJ:["Fe","Ni","Se","Ti"], ENFP:["Ne","Fi","Te","Si"],
  ESTJ:["Te","Si","Ne","Fi"], ESTP:["Se","Ti","Fe","Ni"], ESFJ:["Fe","Si","Ne","Ti"], ESFP:["Se","Fi","Te","Ni"]
};
const GROUP_BY_TYPE={
  INTJ:'analysts', INTP:'analysts', ENTJ:'analysts', ENTP:'analysts',
  ISTJ:'sentinels', ISFJ:'sentinels', ESTJ:'sentinels', ESFJ:'sentinels',
  ISTP:'explorers', ISFP:'explorers', ESTP:'explorers', ESFP:'explorers',
  INFJ:'diplomats', INFP:'diplomats', ENFJ:'diplomats', ENFP:'diplomats'
};
const GROUP_PALETTE={
  analysts:{ main:'#7E57C2', acc:'#9575CD', hi:'#B39DDB' },   /* 紫人组 */
  sentinels:{ main:'#1E88E5', acc:'#42A5F5', hi:'#90CAF9' }, /* 蓝人组 */
  explorers:{ main:'#FBC02D', acc:'#FDD835', hi:'#FFE082' }, /* 黄人组 */
  diplomats:{ main:'#43A047', acc:'#66BB6A', hi:'#A5D6A7' }  /* 绿人组 */
};
const FUNC_DESC={
  Ni:{in:"趋势、模式、远期图景", eval:"预测与必然性推断", out:"长期策略与杠杆点"},
  Ne:{in:"可能性、创意分支", eval:"可选路径评估", out:"探索实验与增长点"},
  Si:{in:"既往经验、基线数据", eval:"稳定性与一致性检验", out:"标准化、复用与风险降低"},
  Se:{in:"现实输入、资源与约束", eval:"即时可行性与体感质量", out:"快速落地与可感知收益"},
  Fi:{in:"个体价值、边界与动机", eval:"价值一致性与伦理校验", out:"价值对齐与拒绝清单"},
  Fe:{in:"群体关系、共识与期待", eval:"社会接受度与协同成本", out:"沟通路径与角色配置"},
  Ti:{in:"概念精确、结构严谨", eval:"逻辑一致性与可证明性", out:"规则化、模型与内核正确性"},
  Te:{in:"目标指标、资源调度", eval:"效率/成本/收益比", out:"执行路线、KPI 与里程碑"},
};
const PHASE_WEIGHTS={
  "探索":{ Ne:.35, Se:.15, Ti:.10, Fi:.10, Fe:.10, Ni:.10, Te:.05, Si:.05 },
  "0_1":{ Ni:.20, Te:.25, Se:.15, Ti:.15, Fi:.05, Fe:.05, Si:.10, Ne:.05 },
  "增长":{ Ne:.25, Te:.20, Fe:.15, Se:.15, Ni:.10, Si:.05, Ti:.05, Fi:.05 },
  "重构":{ Ti:.25, Si:.25, Te:.20, Ni:.10, Se:.10, Fi:.05, Fe:.05, Ne:0 },
  "合规":{ Si:.30, Te:.25, Fe:.15, Ti:.15, Fi:.10, Se:.05, Ni:0, Ne:0 },
};
const GOAL_WEIGHTS={
  "体验":{ Se:.35, Fe:.20, Ne:.15, Si:.05, Fi:.10, Te:.05, Ni:.05, Ti:.05 },
  "效率":{ Te:.35, Ti:.20, Si:.15, Se:.10, Ni:.10, Ne:.05, Fe:.03, Fi:.02 },
  "可扩展":{ Ni:.25, Te:.20, Ti:.20, Si:.15, Ne:.10, Se:.05, Fe:.03, Fi:.02 },
  "稳健":{ Si:.30, Ti:.20, Te:.20, Fi:.10, Fe:.10, Se:.05, Ni:.03, Ne:.02 },
  "探索":{ Ne:.40, Ni:.20, Se:.15, Te:.10, Ti:.05, Fe:.05, Fi:.03, Si:.02 },
};
const CATEGORY_RULES=[
  { key:"mvp",        title:"快速 MVP/可用版本",  contribute:{ Se:.25, Te:.25, Ne:.10, Ti:.10 }, brief:"先落地、后打磨，保障回退。" },
  { key:"refactor",   title:"内核重构/技术债偿还", contribute:{ Ti:.35, Si:.25, Te:.20 },       brief:"防止雪崩，守住可维护性。" },
  { key:"growth",     title:"增长实验/新路径",    contribute:{ Ne:.35, Se:.15, Te:.10, Fe:.10 }, brief:"跑实验—择优—规模化。" },
  { key:"compliance", title:"合规与风控",        contribute:{ Si:.30, Te:.25, Fe:.15, Fi:.10 }, brief:"先合法再扩张，留审计痕迹。" },
  { key:"experience", title:"体验与感知提升",    contribute:{ Se:.35, Fe:.20, Ne:.10 },         brief:"可感知收益 < 3 步可见。" },
  { key:"analytics",  title:"指标化与可观测性",  contribute:{ Te:.30, Ti:.20, Si:.20 },         brief:"量化因果，闭环评估。" },
  { key:"docs",       title:"文档/流程与协作",    contribute:{ Fe:.25, Si:.25, Te:.15, Ti:.10 }, brief:"决策可追溯，可复盘。" },
];
const DEFAULT_STACK_WEIGHTS={ dom:.40, aux:.30, ter:.20, inf:.10 };

/* ====== 小工具 ====== */
const $ = s => document.querySelector(s);
const els = {
  type:$('#type'), phase:$('#phase'), goals:$('#goals'), task:$('#task'),
  manual:$('#manual'), weights:$('#weights'), phaseGoalDesc:$('#phaseGoalDesc'),
  cats:$('#cats'), md:$('#md'), copyMd:$('#copyMd'), resetManual:$('#resetManual'),
  saveProfile:$('#saveProfile'), loadProfile:$('#loadProfile'), exportJSON:$('#exportJSON'),
  demoBtn:$('#demoBtn'), explainToggle:$('#explainToggle'),
  oneLine:$('#oneLine'), nextActions:$('#nextActions'), taskQueue:$('#taskQueue'),
  themeToggle:$('#themeToggle')
};
const state = {
  type:'INTJ', phase:'0_1', goals:['效率','可扩展'], task:'',
  manual:{Ni:0,Ne:0,Si:0,Se:0,Fi:0,Fe:0,Ti:0,Te:0},
  showExplain:true
};
const clamp01=x=>Math.max(0,Math.min(1,x));
const sum=o=>Object.values(o).reduce((a,b)=>a+b,0);
const normalize=w=>{const s=sum(w)||1; const o={}; for(const k in w) o[k]=(w[k]||0)/s; return o;};

/* ====== 主题色随类型 ====== */
function applyGroupThemeByType(type){
  const pal = GROUP_PALETTE[GROUP_BY_TYPE[type]||'analysts'];
  document.documentElement.style.setProperty('--brand', pal.main);
  document.documentElement.style.setProperty('--brand-acc', pal.acc);
  document.documentElement.style.setProperty('--brand-hi', pal.hi);
  document.documentElement.style.setProperty('--btn-bg', pal.main);
}

/* ====== 权重计算 ====== */
function fuseWeights(type, phase, goals, manual){
  const stack = MBTI_STACKS[type] || MBTI_STACKS.INTJ;
  const [dom,aux,ter,inf] = stack;
  const wStack={Ni:0,Ne:0,Si:0,Se:0,Fi:0,Fe:0,Ti:0,Te:0};
  wStack[dom]+=DEFAULT_STACK_WEIGHTS.dom; wStack[aux]+=DEFAULT_STACK_WEIGHTS.aux;
  wStack[ter]+=DEFAULT_STACK_WEIGHTS.ter; wStack[inf]+=DEFAULT_STACK_WEIGHTS.inf;
  const wPhase = PHASE_WEIGHTS[phase]||{};
  const wGoal={Ni:0,Ne:0,Si:0,Se:0,Fi:0,Fe:0,Ti:0,Te:0};
  goals.forEach(g=>{const gw=GOAL_WEIGHTS[g]||{}; for(const [k,v] of Object.entries(gw)) wGoal[k]+=v||0;});
  const combined={Ni:0,Ne:0,Si:0,Se:0,Fi:0,Fe:0,Ti:0,Te:0};
  for(const k in combined) combined[k]=clamp01((wStack[k]||0)+(wPhase[k]||0)+(wGoal[k]||0)+(manual[k]||0));
  return normalize(combined);
}
function scoreCategories(funcW){
  return CATEGORY_RULES.map(cat=>{
    let score=0; const contrib=[];
    for(const [f,w] of Object.entries(cat.contribute)){const s=(funcW[f]||0)*(w||0); if(s>0) contrib.push([f,s]); score+=s;}
    return {...cat, score:+(score*100).toFixed(1), contrib:contrib.sort((a,b)=>b[1]-a[1])};
  }).sort((a,b)=>b.score-a.score);
}

/* ====== 任务解析/打分 ====== */
function parseTasks(raw){
  if(!raw) return [];
  let text = String(raw).replace(/\u00A0/g,' ').trim();
  let parts = text.split(/\r?\n+|[;；。\.、，,]+/);
  parts = parts.flatMap(s=>s.split(/\s*(?:和|与|及|、|\s\/\s|\s\|\s)\s*/));
  return parts.map(s=>s.trim())
    .map(s=>s.replace(/^(\d+[\.\)）:、-]|\([0-9]+\)|[①-⑳]|[一二三四五六七八九十]+、|[-•·])\s*/, ''))
    .filter(Boolean).filter((t,i,a)=>a.indexOf(t)===i).map(text=>({text}));
}
function pickUrgency(t){
  if(/今天|今晚|立刻|马上|尽快|DDL|截止|现在/.test(t)) return 1.0;
  if(/明天|后天|本周|这周|周[一二三四五六日天]/.test(t)) return 0.8;
  if(/\b(今|本|这|下)月\b|\d{1,2}(号|日)/.test(t)) return 0.65;
  if(/长期|以后|了解|学习|探索/.test(t)) return 0.4;
  return 0.55;
}
function relationBoost(t){
  if(/客户|甲方|老板|上级|导师|老师/.test(t)) return 0.20;
  if(/伴侣|对象|父母|爸妈|孩子|朋友/.test(t)) return 0.15;
  return 0;
}
function pickImpact(t){
  let b=0.5;
  if(/汇报|复盘|面试|考试|交付|上线|合规|合同|签约|付款|收款/.test(t)) b=0.85;
  if(/渗水|漏水|维修|健康|体检|就医|过期/.test(t)) b=Math.max(b,0.75);
  if(/学习|阅读|整理|备份|归档/.test(t)) b=Math.max(b,0.55);
  return Math.min(1, b + relationBoost(t));
}
function pickEffort(t){
  let e=1.0;
  if(/预约|电话|缴费|短信|邮件|确认|开票|打印/.test(t)) e=Math.min(e,0.6);
  if(/做饭|打扫|搬运|采购|维修|医院|银行|窗口/.test(t)) e=Math.max(e,1.2);
  if(/PPT|报告|方案|代码|排查|调研|学习|论文|整理/.test(t)) e=Math.max(e,1.1);
  if(/长期|项目|系列/.test(t)) e=Math.max(e,1.4);
  return e;
}
function matchCategoryForTask(t){
  const dict=[
    {key:'compliance', kw:/合规|发票|报销|合同|资质|权限|审计|隐私|备案|税/i, label:'合规/风控'},
    {key:'mvp',        kw:/上线|交付|发布|试用|灰度|验收|演示|demo|原型/i, label:'MVP/可用版'},
    {key:'refactor',   kw:/重构|修复|优化|技术债|性能|崩溃|错误|bug/i, label:'重构/技术债'},
    {key:'growth',     kw:/拉新|转化|留存|活动|投放|渠道|实验|AB|增长/i, label:'增长实验'},
    {key:'experience', kw:/体验|交互|视觉|可用性|无障碍|加载|首屏|反馈/i, label:'体验提升'},
    {key:'analytics',  kw:/埋点|统计|报表|看板|指标|监控|日志|分析|数据/i, label:'指标化/观测'},
    {key:'docs',       kw:/文档|流程|SOP|规范|周报|月报|ADR|记录|整理|归档/i, label:'文档/流程'},
    {key:'health',     kw:/体检|医院|就医|药|复查|睡眠|锻炼|牙科/i, label:'健康'},
    {key:'house',      kw:/渗水|漏水|维修|家电|保洁|搬家|物业|装修|换锁|快递/i, label:'居家/后勤'},
    {key:'relation',   kw:/伴侣|父母|爸妈|孩子|朋友|客户|老板|上级|导师|老师/i, label:'关系沟通'},
    {key:'study',      kw:/学习|阅读|刷题|考试|复习|课程|作业|论文|备考|练习/i, label:'学习/提升'},
  ];
  for(const it of dict){ if(it.kw.test(t)) return it; }
  return {key:'general', label:'一般事务'};
}
function scoreTaskArray(tasks, topCat){
  const topKey = topCat?.key;
  return tasks.map(t=>{
    const u=pickUrgency(t.text), i=pickImpact(t.text), e=Math.max(0.6, pickEffort(t.text));
    const match=matchCategoryForTask(t.text);
    const m = match.key===topKey ? 1 : (/general/.test(match.key)?0:0.5);
    const score = ((i*0.50 + u*0.35 + m*0.15) / e) * 100;
    return {...t, u, i, e, matchKey:match.key, matchLabel:match.label, score};
  }).sort((a,b)=> b.score - a.score);
}

/* ====== Markdown ====== */
function toMarkdown({type,phase,goals,funcWeights,categories,task,showExplain,tasksSorted}){
  const fw = Object.entries(funcWeights).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`- ${k}: ${(v*100).toFixed(1)}%`).join('\n');
  const cats = categories.slice(0,6).map(c=>`### ${c.title}｜${c.score}\n> ${c.brief}\n来源：`+c.contrib.map(([f,s])=>`${f} ${(s*100).toFixed(1)}%`).join(' · ')).join('\n\n');
  const tasksMd = (tasksSorted||[]).map((t,i)=>`${i+1}. ${t.text}  `+`· 紧急:${(t.u*100).toFixed(0)}%｜影响:${(t.i*100).toFixed(0)}%｜努力:${t.e.toFixed(1)}  `+`· 匹配:${t.matchLabel}｜总分:${t.score.toFixed(2)}`).join('\n');
  return `# 决策报告 ${showExplain?'（含解释）':'（简洁版）'}

**类型**：${type}    **阶段**：${phase.replace('0_1','0→1')}    **目标**：${goals.join(' / ')||'未选'}

**任务**：
${(task||'').trim()||'（未填写）'}

---

## 任务优先队列（高→低）
${tasksMd||'（未检测到可排序的任务，每行一条）'}

---

## 功能权重
${fw}

---

## 建议优先级（Top 6）
${cats}
`;
}

/* ====== UI 渲染 ====== */
function initSelectors(){
  els.type.innerHTML = Object.keys(MBTI_STACKS).map(t=>`<option value="${t}">${t}（${MBTI_STACKS[t].join('-')}）</option>`).join('');
  els.type.value = state.type;
  els.phase.innerHTML = Object.keys(PHASE_WEIGHTS).map(p=>`<option value="${p}">${p==='0_1'?'0→1':p}</option>`).join('');
  els.phase.value = state.phase;
  renderGoals(); renderManual();
}
function renderGoals(){
  els.goals.innerHTML = '';
  Object.keys(GOAL_WEIGHTS).forEach(g=>{
    const div=document.createElement('div');
    div.className='chip'+(state.goals.includes(g)?' on':'');
    div.textContent=g;
    div.onclick=()=>{const i=state.goals.indexOf(g); if(i>=0) state.goals.splice(i,1); else state.goals.push(g); renderGoals(); computeAndRender();};
    els.goals.appendChild(div);
  });
}
function renderManual(){
  els.manual.innerHTML='';
  Object.keys(FUNC_DESC).forEach(f=>{
    const row=document.createElement('div'); row.className='row';
    const lab=document.createElement('div'); lab.className='sub'; lab.style.width='32px'; lab.textContent=f; row.appendChild(lab);
    const r=document.createElement('input'); r.type='range'; r.min=0; r.max=0.5; r.step=0.01; r.value=state.manual[f]||0;
    const v=document.createElement('div'); v.className='sub'; v.style.width='40px'; v.style.textAlign='right'; v.textContent=r.value;
    r.oninput=()=>{state.manual[f]=parseFloat(r.value); v.textContent=r.value};
    r.onchange=computeAndRender;
    row.append(r,v); els.manual.appendChild(row);
  });
}

/* ====== 主渲染函数（全兜底） ====== */
function computeAndRender(){
  try{
    applyGroupThemeByType(state.type);

    const funcW = fuseWeights(state.type, state.phase, state.goals, state.manual) || {};
    const cats  = scoreCategories(funcW) || [];
    const top   = cats[0] || null;

    const maxFW = Math.max(0.0001, ...Object.values(funcW));
    els.weights.innerHTML = Object.entries(funcW)
      .sort((a,b)=>b[1]-a[1]).map(([f,v])=>{
        const d = FUNC_DESC[f] || {in:'—',eval:'—',out:'—'};
        const detail = state.showExplain
          ? `<div class="sub">输入：${d.in}</div><div class="sub">评估：${d.eval}</div><div class="sub">输出：${d.out}</div>` : '';
        return `<div class="item">
          <div class="kv"><div><b>${f}</b></div><div class="sub">${(v*100).toFixed(1)}%</div></div>
          <div class="bar"><i style="width:${(v/maxFW*100).toFixed(1)}%"></i></div>${detail}
        </div>`;
      }).join('') || `<div class="sub">（暂无权重数据）</div>`;
    if(els.explainToggle) els.explainToggle.textContent = '解释：' + (state.showExplain?'开启':'关闭');

    if(els.phaseGoalDesc){
      els.phaseGoalDesc.textContent = `当前阶段：${state.phase==='0_1'?'0→1':state.phase}；目标：${state.goals.join(' / ')||'未选'}`;
    }

    const summaryMap={
      '快速 MVP/可用版本':'先做能跑起来的版本，灰度上线并预留回退。',
      '内核重构/技术债偿还':'优先修内核与债务，保证稳定与可维护性。',
      '增长实验/新路径':'先开实验槽位，跑两条主假设，择优放大。',
      '合规与风控':'把合规与审计补齐，再考虑扩张与推广。',
      '体验与感知提升':'把可感知收益前置到 3 步内，反馈要即刻可见。',
      '指标化与可观测性':'先把关键指标与埋点打通，决策要可量化。',
      '文档/流程与协作':'把决策留痕与流程标准化，确保可复盘。'
    };
    if(els.oneLine) els.oneLine.textContent = top ? (summaryMap[top.title] || top.brief || '') : '（请先填写上方参数与任务）';

    const actionsMap={
      '快速 MVP/可用版本':['列出最小闭环用户路径','灰度 3 批次，每批 10~20% 用户','定义回退与成功判据'],
      '内核重构/技术债偿还':['标注高复杂度模块并排期重构','补齐单元与集成测试','冻结新增特性直至质量达标'],
      '增长实验/新路径':['写出两条核心假设与指标','设计低成本实验与退出条件','设置 2 周复盘会'],
      '合规与风控':['梳理数据与权限矩阵','开启审计日志','完成合规清单自查'],
      '体验与感知提升':['压缩首屏关键路径','加入即时反馈/提示','用户访谈 5 人验证感知'],
      '指标化与可观测性':['定义北极星与 3 个过程指标','补埋点→校验数据链路','搭建周报模板'],
      '文档/流程与协作':['补齐 ADR/变更记录','定义 DoR/DoD','建立每周同步节奏']
    };
    if(els.nextActions){
      const acts = top ? (actionsMap[top.title] || []) : [];
      els.nextActions.innerHTML = acts.slice(0,3).map(a=>`<div class="item"><div class="sub">${a}</div></div>`).join('')
        || `<div class="sub">（暂无建议动作）</div>`;
    }

    const tasks = parseTasks(state.task || '');
    const tasksSorted = scoreTaskArray(tasks, top);
    if(els.taskQueue){
      const maxScore = Math.max(1, ...tasksSorted.map(t=>t.score||0));
      els.taskQueue.innerHTML = tasksSorted.slice(0,10).map(t=>`
        <div class="item">
          <div class="kv"><div>${t.text}</div><div class="sub">${(t.score||0).toFixed(1)}</div></div>
          <div class="bar"><i style="width:${(t.score/maxScore*100).toFixed(1)}%"></i></div>
          <div class="sub">紧急:${((t.u||0)*100).toFixed(0)}% ｜ 影响:${((t.i||0)*100).toFixed(0)}% ｜ 努力:${(t.e||1).toFixed(1)} ｜ 匹配:${t.matchLabel||'—'}</div>
        </div>
      `).join('') || `<div class="sub">（未检测到可排序的任务，每行一条）</div>`;
    }

    if(els.md){
      els.md.textContent = toMarkdown({
        type:state.type, phase:state.phase, goals:state.goals,
        funcWeights:funcW, categories:cats, task:state.task,
        showExplain:state.showExplain, tasksSorted
      });
    }
  }catch(err){ toast('渲染异常：'+(err?.message||err)); }
}

/* ====== 事件 ====== */
function bindEvents(){
  els.type.onchange = ()=>{ state.type=els.type.value; computeAndRender(); };
  els.phase.onchange= ()=>{ state.phase=els.phase.value; computeAndRender(); };
  els.task.oninput  = ()=>{ state.task=els.task.value; computeAndRender(); };
  els.resetManual.onclick = ()=>{ state.manual={Ni:0,Ne:0,Si:0,Se:0,Fi:0,Fe:0,Ti:0,Te:0}; renderManual(); computeAndRender(); };
  els.saveProfile.onclick = ()=>{ try{ SafeStore.setItem('mbti_decider_profile_offline', JSON.stringify(state)); toast('已保存到本地'); }catch{ toast('保存失败：环境限制'); } };
  els.loadProfile.onclick = ()=>{ try{ const raw=SafeStore.getItem('mbti_decider_profile_offline'); if(!raw){ toast('没有找到本地配置'); return; } Object.assign(state, JSON.parse(raw)); els.type.value=state.type; els.phase.value=state.phase; els.task.value=state.task||''; renderGoals(); renderManual(); computeAndRender(); toast('已读取配置'); }catch{ toast('读取失败：数据格式异常'); } };
  els.exportJSON.onclick = ()=>{ const json=JSON.stringify(state,null,2); safeDownload(`mbti_decider_profile_${state.type}.json`, json, 'application/json'); };
  els.demoBtn.onclick = ()=>{ state.type='INTJ'; state.phase='0_1'; state.goals=['效率','可扩展']; state.task=`给父母体检预约（周六）
厨房水槽渗水（影响做饭）
下周一周会汇报（PPT）
恢复每周两次力量训练
跟伴侣沟通上周争吵`; state.manual={Ni:0.05,Ne:0,Si:0.05,Se:0,Fi:0,Fe:0,Ti:0.10,Te:0.20}; els.type.value=state.type; els.phase.value=state.phase; els.task.value=state.task; renderGoals(); renderManual(); computeAndRender(); };
  els.copyMd.onclick = ()=> safeCopy(els.md.textContent || '');
  els.explainToggle.onclick = ()=>{ state.showExplain=!state.showExplain; computeAndRender(); };
}

/* ====== 启动 ====== */
(function(){
  try{ const raw=SafeStore.getItem('mbti_decider_profile_offline'); if(raw) Object.assign(state, JSON.parse(raw)); }catch{}
  initSelectors(); bindEvents(); els.task.value=state.task||'';
  applyGroupThemeByType(state.type); computeAndRender();
  const isLight=document.body.classList.contains('theme-light');
  if(els.themeToggle) els.themeToggle.textContent='切换主题：'+(isLight?'白天':'夜晚');
})();
</script>
</body>
</html>
